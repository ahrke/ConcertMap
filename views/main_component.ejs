<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Home Page</title>

    <link rel="stylesheet" href="/vendor/normalize-4.1.1.css" type="text/css" />
    <link rel="stylesheet" href="/vendor/border-box.css" type="text/css" />
    <link rel="stylesheet" href="/styles/layout.css" type="text/css" />
    <link rel="stylesheet" href="/styles/artist.css" type="text/css" />
    <link rel="stylesheet" href="/styles/main_component.css" type="text/css" />
    <link rel="stylesheet" href="/styles/list_area.css" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <script type="text/javascript" src="/vendor/jquery-3.0.0.js"></script>
    <script type="text/javascript" src="/scripts/app.js"></script>
    <script type="text/javascript" src="/scripts/spotify.js"></script>
    <script type="text/javascript" src="/scripts/songkick.js"></script>
    <script type="text/javascript" src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  </head>

  <body>
    <% include partials/__nav %>

    <div id="mainArea">
      <section id="listArea" class='scroll'>
        <ul>
          <% for (let concert of concerts) { %>
            <li id="<%= concert.songkick_event_id %>" onclick="showArtist(this.id)">
              <div class='concertListing'>
                <img src='<%= concert.image640 %>'>
                <p class='listDetails'>
                  <span class='listTitle'><%= concert.concertName.split('(')[0] %></span>
                  <span class='listDateArea'>
                    <span class='listDate'><%= concert.start.date %></span>
                    <span class='listTime'><%= concert.start.time %></span>
                  </span>
                </p>
              </div>
            </li>
          <% } %>
        </ul>
        <h2>

        </h2>
      </section>

      <div class="toFloat">
        <section id="artistArea" class='scroll'>
          <div id="artists"></div>
        </section>
      </div>


      <section id="mapArea">

        <h1>mapArea</h1>
      </section>

    </main>

    <%
    let collection = concerts.map(concert => {
      let artists = concert.performers.map(performer => performer.displayName.replace(/[^a-zA-Z ]/g, '')).join(',');
      return [
        concert.songkick_event_id,
        artists
      ]
    }).join('||')

    %>

    <script type="text/javascript">

      // We need to retrieve the collection of artists, as well as the id of the event/concert they belong to
      let collection = "<%= collection %>".split('||').map(item => {
        let id = item.split(',')[0];
        let artists = item.split(',').slice(1)
        return {
          id,
          artists
        }
      })
      console.log(collection)

      function getHashParams() {
        var hashParams = {};
        var e, r = /([^&;=]+)=?([^&;]*)/g,
        q = window.location.hash.substring(1);
        while ( e = r.exec(q)) {
          hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
      }

      let hashParams = {};

      if (window.location.hash) {
        hashParams = getHashParams();
      }

      let artists = {}

      getArtistsInfo(collection,hashParams.access_token)
        .then(res => {
          artists = res;
          console.log("from main_component, artists: ",artists)
        })
        .catch(e => console.error("error from getArtistInfo call: ",e))

      let showArtist = (id) => {
        console.log("showArtist called from id ==> ",id)
        $("#artistArea").css('display','flex');
        console.log("displaying artists[id][0] info ===> ",artists[id][0])
        artistDisplay(artists[id][0]);
      }

    </script>
  </body>
</html>
